---
title: "new_diversity_figures"
author: "Matt Doherty"
date: "2/25/2017"
output: html_document
---

```{r knitr-setup, include=FALSE}
source('../code/knitr_settings.R')
source('../code/R_packages_setup.R')
```

```{r readdata, include=F}
#Read in all data
source('../code/APmd.setup.R')




screen_RESPwk22<-APmd_RSPwk22[APmd_RSPwk22$visit=="Screening",] #removes any group with NA in RESPONSEwk22

screen_data<-screen_RESPwk22				#na.omit(screen_RESPwk22)
summary(subset(screen_data, select=c(group, USUBJID, visit, TRTGR, TRTGRINDMAN, RESPONSEwk8)))

#screen_data<-screen_data[screen_data$USUBJID!='C0743T26030100002',]
#screen_data<-screen_data[screen_data$group!='E4859941-5',]

summary(subset(screen_data, select=c(group, USUBJID, visit, TRTGR, TRTGRINDMAN, RESPONSEwk8)))

#screen_data$CDSTOOLM_Screening[screen_data$CDSTOOLM_Screening=="."]<-"NA"
#screen_data$CDSTOOLM_Screening <-as.integer(screen_data$CDSTOOLM_Screening)
#screen_data$CDHCTM_Screening[screen_data$CDHCTM_Screening=="."]<-"NA"
#screen_data$CDHCTM_Screening <-as.integer(screen_data$CDHCTM_Screening)
summary(subset(screen_data, select=c(group, USUBJID, visit, TRTGR, TRTGRINDMAN, RESPONSEwk8)))

#levs<-screen_data %>% group_by(USUBJID) %>% summarise(no_rows = length(USUBJID))
#levs

#dup.group<-screen_data[screen_data$USUBJID=="C0743T26045400006",]
#subset(dup.group, select = c(group, USUBJID, visit, nseqs, coverage, sobs, invsimpson))

#Remove "duplicate" sample with worse coverage and nseqs
#screen_data<-screen_data[screen_data$group!='E4859941-5',] #data = cleaned up duplicate removed
#summary(subset(screen_data, select=c(group, USUBJID, visit, TRTGR, TRTGRINDMAN, RESPONSEwk8)))

screen_data<-screen_data[screen_data$TRTGRINDMAN!="Placebo_Not",]
screen_data<-screen_data[screen_data$TRTGRINDMAN!="Treated_Not",]
#screen_data<-screen_data[screen_data$TRTGRINDMAN!="Placebo_Not",]

#pdf('data/figures/patientMD.#pdf', height=6, width=8)
summary(screen_data[,c("TRTGR", "TRTGRINDMAN", "visit", "RESPONSEwk6", "RelRSPwk6", "REMISSwk6")])
#dev.off()

screen.trtd<-screen_data[screen_data$TRTGRINDMAN!="Placebo_Placebo",]
screen.trtd<-screen.trtd[screen.trtd$TRTGRINDMAN!="Placebo_Treated",]
summary(screen.trtd[,1:6])
screen.plac<-screen_data[screen_data$TRTGRINDMAN!="Treated_Placebo",]
screen.plac<-screen.plac[screen.plac$TRTGRINDMAN!="Treated_Treated",]
summary(screen.plac[,1:6])

nao.screen_data<-na.omit(screen_data)

nao.screen.trtd<-nao.screen_data[nao.screen_data$TRTGRINDMAN!="Placebo_Placebo",]
nao.screen.trtd<-nao.screen.trtd[nao.screen.trtd$TRTGRINDMAN!="Placebo_Treated",]
summary(nao.screen.trtd[,1:6])
nao.screen.plac<-nao.screen_data[nao.screen_data$TRTGRINDMAN!="Treated_Placebo",]
nao.screen.plac<-nao.screen.plac[nao.screen.plac$TRTGRINDMAN!="Treated_Treated",]
summary(nao.screen.plac[,1:6])

#axes <- read.table('../data/Jan400.nao.screen_trtd.3107.subsample.thetayc.0.03.lt.ave.nmds.by3.axes', header=T)
tax<- read.table('../data/Jan400.simple.taxonomy.txt', header=T, sep="\t")
nao.screen.all.distmat<-read.table("../data/Jan400.screening.all.na.omit.cmd.thetayc.0.03.square.ave.dist")
nao.screen.all.dist<-as.dist(nao.screen.all.distmat)
nao.screen.trtd.distmat<-read.table("../data/Jan400.screening.ust.na.omit.cmd.thetayc.0.03.square.ave.dist")
nao.screen.trtd.dist<-as.dist(nao.screen.trtd.distmat)
nao.screen.plac.distmat<-read.table("../data/Jan400.screening.plac.na.omit.cmd.thetayc.0.03.square.ave.dist")
nao.screen.plac.dist<-as.dist(nao.screen.plac.distmat)

screen.all.distmat<-read.table("../data/Jan400.screen.all.thetayc.0.03.square.ave.dist")
screen.all.dist<-as.dist(screen.all.distmat)
screen.trtd.distmat<-read.table("../data/Jan400.screen.ust.thetayc.0.03.square.ave.dist")
screen.trtd.dist<-as.dist(screen.trtd.distmat)
screen.plac.distmat<-read.table("../data/Jan400.screen.plac.thetayc.0.03.square.ave.dist")
screen.plac.dist<-as.dist(screen.plac.distmat)

trtd_trtd.data.distmat<-read.table("../data/Jan400.trtd_trtd.accnos.na.omit.cmd.thetayc.0.03.square.ave.dist")
trtd_trtd.data.dist<-as.dist(trtd_trtd.data.distmat)
trtd_plac.data.distmat<-read.table("../data/Jan400.trtd_plac.accnos.na.omit.cmd.thetayc.0.03.square.ave.dist")
trtd_plac.data.dist<-as.dist(trtd_plac.data.distmat)
plac_plac.data.distmat<-read.table("../data/Jan400.plac_plac.accnos.na.omit.cmd.thetayc.0.03.square.ave.dist")
plac_plac.data.dist<-as.dist(plac_plac.data.distmat)
plac_trtd.data.distmat<-read.table("../data/Jan400.plac_trtd.accnos.na.omit.cmd.thetayc.0.03.square.ave.dist")
plac_trtd.data.dist<-as.dist(plac_trtd.data.distmat)
```	

```{r tax analysis setup, echo=FALSE}
source('../code/tax.analysis.setup.R')
```

```{r}
source("../code/phylum.analysis.R")

```

I've been working to improv my figures and analysis for the paper and future presenations. Below I show the results from doing wilcox/kruskal tests across phyla and OTUs and then adjusting the p values using the "BH method".

###Phyla
No phyla were significantly different after multiple corrections, but there are some phyla that appear enriched in non-remitters compared to remitters and vice versa.

```{r, fig.height= 5, fig.width=10}
barplot(mean_abundant_phylum_matrix,
				beside=T,
				col=c("red", "orange", "yellow", "green", "blue", "violet"),
				names.arg=colnames(mean_abundant_phylum_matrix),
				legend=T, 
				ylab="Relative Abundance (%)", xlab= "Remission Week 6")

box()
```

This is a base plot showing the differences in phylum by Remission at Week 6, but I didn't like the look of it and talked to Nick and Amanda, who helped me with ggplot-ing it.

```{r, fig.height= 5, fig.width=10}
phylum_figure <- ggplot(phyRabREMISSwk6_ggplot, aes(x=REMISSwk6, y=relabund, fill=phylum)) +
	#stat_summary(fun.y=median, geom="point", aes(fill = phylum), position = position_dodge(1)) +
	#stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5), position = position_dodge(1), geom='errorbar', aes(color = phylum))+
	geom_boxplot(aes(col=phylum), position=position_dodge(width = 1), alpha = .4) +
	theme(legend.text = element_text(face = "italic")) + ylab("Relative Abundance (%)") + xlab("Week 6 Remission")

phylum_figure
```

I think the ggplot look much better, but not sure if it is the best way to show the comparison so I tried showing each phylum by remission status at week 6.

```{r, fig.height= 5, fig.width=10}
plot(NA, ylim=c(0,100), xlim=c(1,19), ylab="Relative Abundance", xlab="", axes=F)
boxplot(phylum_rel_abund[,1]~screen_data$REMISSwk6, at=2:3, names=F, add=T, axes=F, col=c("blue", "red"))
boxplot(phylum_rel_abund[,2]~screen_data$REMISSwk6, at=5:6, names=F, add=T, axes=F, col=c("blue", "red"))
boxplot(phylum_rel_abund[,3]~screen_data$REMISSwk6, at=8:9, names=F, add=T, axes=F, col=c("blue", "red"))
boxplot(phylum_rel_abund[,4]~screen_data$REMISSwk6, at=11:12, names=F, add=T, axes=F, col=c("blue", "red"))
boxplot(phylum_rel_abund[,5]~screen_data$REMISSwk6, at=14:15, names=F, add=T, axes=F, col=c("blue", "red"))
boxplot(phylum_rel_abund[,6]~screen_data$REMISSwk6, at=17:18, names=F, add=T, axes=F, col=c("blue", "red"))
axis(1, labels=colnames(phylum_rel_abund)[1:6], at=c(1,4,7,10,13,16)+1.5, tick=F, cex.axis=1, line=-1, font = 3)
axis(2, las=2)
legend(x=16, y=95, legend=c("Nonremitter", "Remitter"), pch = 15, col=c("blue", "red"), title = "Week 6")
box()
```

This base plot might be my preffered way to show the data so far.

```{r, fig.height= 5, fig.width=10}
phylum_figure2 <- ggplot(phyRabREMISSwk6_ggplot, aes(x=REMISSwk6, y=relabund, fill=REMISSwk6)) +
	#stat_summary(fun.y=median, geom="point", aes(fill = phylum), position = position_dodge(1)) +
	#stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5), position = position_dodge(1), geom='errorbar', aes(color = phylum))+
	geom_boxplot(position=position_dodge(width = 1), alpha = .4) +facet_grid(. ~ phylum) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission") + theme(legend.position="none") + theme(strip.text = element_text(face = "italic"))

phylum_figure2
```

Almose the same thing with ggplot.




###OTUS
Several OTUs were significantly different following p value adjustment for Week 6 Remisssion, thouhg for many of these they were not very abundant. I decided to show OTUs with over 0.5% abundance.

```{r, fig.height= 5, fig.width=10}
source("../code/otu.analysis.R")
source('../code/REMISSwk6.sig.otu.figure.R')

```

The old familiar base plot stripcharts might still be my preferred way of veiwing the otus

```{r, fig.height= 5, fig.width=10}
cbind(data.frame(labeled_mean_signif_REMISSwk6_otu_matrix, otu = row.names(labeled_mean_signif_REMISSwk6_otu_matrix))) %>%
	gather(response, relabund, -otu) %>% ggplot(aes(x=response, y=relabund, fill=otu)) +
	geom_bar(position = "dodge",stat="identity") + scale_fill_discrete(labels=labs, breaks = levels(tax_mean_signif_REMISSwk6_otu_matrix$Label)) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission")





cbind(data.frame(Vabund_mean_signif_REMISSwk6_otu_matrix, otu = row.names(Vabund_mean_signif_REMISSwk6_otu_matrix))) %>%
	gather(response, relabund, -otu) %>% ggplot(aes(x=response, y=relabund, fill=otu)) +
	geom_bar(position = "dodge",stat="identity") + 
	scale_fill_discrete(labels=labs, breaks = levels(tax_mean_signif_REMISSwk6_otu_matrix$Label)) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission")


cbind(data.frame(Mabund_mean_signif_REMISSwk6_otu_matrix, otu = row.names(Mabund_mean_signif_REMISSwk6_otu_matrix))) %>%
	gather(response, relabund, -otu) %>% ggplot(aes(x=response, y=relabund, fill=otu)) +
	geom_bar(position = "dodge",stat="identity") + 
	scale_fill_discrete(labels=labs, breaks = levels(tax_mean_signif_REMISSwk6_otu_matrix$Label)) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission")



cbind(data.frame(Labund_mean_signif_REMISSwk6_otu_matrix, otu = row.names(Labund_mean_signif_REMISSwk6_otu_matrix))) %>%
	gather(response, relabund, -otu) %>% ggplot(aes(x=response, y=relabund, fill=otu)) +
	geom_bar(position = "dodge",stat="identity") + 
	scale_fill_discrete(labels=labs, breaks = levels(tax_mean_signif_REMISSwk6_otu_matrix$Label)) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission")
```

These show the OTUs by mean relative abundance together and then broken down by relative abundance to show the differences. This seems like overkill, but the breakdown might be good for supp figures.

```{r, fig.height= 5, fig.width=12}
ggplot(otuRabREMISSwk6_ggplot, aes(x=REMISSwk6, y=relabund, fill=REMISSwk6)) + facet_grid(. ~ otu) +
	#stat_summary(fun.y=median, geom="point", aes(fill = otu), position = position_dodge(1)) +
	#stat_summary(fun.data = 'median_hilow', fun.args = (conf.int=0.5), position = position_dodge(1), geom='errorbar', aes(color = otu))+
	geom_boxplot(position=position_dodge(width = 1), alpha = .4) + scale_y_log10() + guides(fill=FALSE) + theme(strip.text = element_text(face = "italic")) +
	ylab("Relative Abundance (%)") + xlab("Week 6 Remission") + theme(legend.position="none")
```

In this plot zero values have been removed due to the log scale on the y axis, so i am not sure if it best represents the data.


